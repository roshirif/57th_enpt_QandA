<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Q&A一覧</title>

  <!-- DataTables CSS（CDN） -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

  <style>
    /* スマホでも見やすい最低限のスタイル */
    body {
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "メイリオ", Arial, sans-serif;
      margin: 12px;
      background: #f7fbff;
      color: #222;
    }
    h1 {
      font-size: 1.25rem;
      margin-bottom: 8px;
    }

    /* テーブルを包むボックス */
    .table-wrap {
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(20,30,60,0.06);
    }

    /* DataTables デフォルトを少し整える */
    table.dataTable thead th {
      background: linear-gradient(#fbfdff, #eef6ff);
    }

    /* 小さい画面で改行しやすく */
    td {
      word-break: break-word;
      vertical-align: top;
    }

    /* 読み込み中メッセージ */
    #loading {
      margin: 10px 0;
      color: #666;
    }

    /* エラー表示 */
    #error {
      color: #b00020;
      margin: 10px 0;
    }

    /* 列幅＆テーブル調整 */
    table.dataTable {
      width: 100% !important;
      table-layout: fixed; /* 列幅を固定レイアウトにする */
      word-wrap: break-word; /* 長い単語の折り返し */
    }

    /* 日時列（1列目） */
    table.dataTable th:nth-child(1),
    table.dataTable td:nth-child(1) {
      width: 15%;
    }

    /* 担当役職列（2列目） */
    table.dataTable th:nth-child(2),
    table.dataTable td:nth-child(2) {
      width: 20%;
    }

    /* 質問内容列（3列目） */
    table.dataTable th:nth-child(3),
    table.dataTable td:nth-child(3) {
      width: 40%;
    }

    /* 回答列（4列目） */
    table.dataTable th:nth-child(4),
    table.dataTable td:nth-child(4) {
      width: 25%;
    }

    /* 役職絞り込みセレクトのスタイル（ちょっと余白） */
    #roleFilter {
      margin-bottom: 12px;
      padding: 4px 8px;
      font-size: 1rem;
    }
    label[for="roleFilter"] {
      font-weight: bold;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h1>Q＆A一覧</h1>

  <!-- ここに役職絞り込みセレクトを追加 -->
  <label for="roleFilter">役職で絞り込み：</label>
  <select id="roleFilter">
    <option value="">すべて</option>
  </select>

  <div id="loading">読み込み中…</div>
  <div id="error" style="display:none;"></div>

  <div class="table-wrap" style="display:none" id="tableContainer">
    <table id="qnaTable" class="display" style="width:100%">
      <thead>
        <tr>
          <th>日時</th>
          <th>担当役職</th>
          <th>質問内容</th>
          <th>回答</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- jQuery & DataTables JS（CDN） -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <script>
    // 日付を yyyy/mm/dd に整形する関数
    function formatDateOnly(val) {
      if (!val) return "";
      let d = new Date(val);
      if (!isNaN(d.getTime())) {
        let y = d.getFullYear();
        let m = String(d.getMonth() + 1).padStart(2, '0');
        let day = String(d.getDate()).padStart(2, '0');
        return `${m}/${day}`;
      }
      return String(val).slice(0, 10).replace(/-/g, '/');
    }

    // ここをあなたのApps ScriptのWebアプリURLに置き換えてください
    const apiURL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgDLzxz_9kMGlmXQkVhA54pJz87fIeROMa5Acqo31lpkGAkCNsK5vDkVIViq6h3mupWuPrFnxb06tGJTOyWx4wEqERRYoNfriJxkW2wYyAEeZii3aGc9kJ4k8ql2-Wyczm_p6XhaVgP99nVGaFSFtsO00fsQIq1tRLh3VvNKsTKmZiWDv3FJN_PChv_CZrg7llRSOFL7mZTveBJTaPGJTLE77RD32QZrWA_1B5RtPaUt2OdhNJ-Ji209CuajZ9IYM5wX7QpZVladJmthOgh4f4IH4DXgYlLX_3l9RVN&lib=MFpjrwhdvOnkvXxRHX2Dj7moQQNnbGCso";

    // JSONのキー名（スプレッドシートのヘッダー名）に合わせて変更可能
    const KEY_DATETIME = "日時";
    const KEY_QUESTION = "質問内容";
    const KEY_ANSWER = "回答";
    const KEY_ROLE = "担当役職";  // 役職列のキー

    $(document).ready(function() {
      fetchDataAndRender();

      // 役職絞り込み選択肢変更時
      $('#roleFilter').on('change', function() {
        const val = $(this).val();
        // 役職列は2列目（index 1）なので1を指定して検索
        $('#qnaTable').DataTable().column(1).search(val).draw();
      });
    });

    function fetchDataAndRender() {
      $('#loading').show();
      $('#error').hide();
      $('#tableContainer').hide();

      fetch(apiURL)
        .then(res => {
          if (!res.ok) throw new Error("ネットワークエラー: " + res.status);
          return res.json();
        })
        .then(data => {
          if (!Array.isArray(data)) throw new Error("取得データが配列ではありません");

          // 役職のセット作成（重複なし）
          const roleSet = new Set();

          const rowsHtml = data.map(item => {
            let dtRaw = item[KEY_DATETIME] ?? item["Timestamp"] ?? item["タイムスタンプ"] ?? "";
            let dt = formatDateOnly(dtRaw);
            const q  = item[KEY_QUESTION] ?? item["質問"] ?? item["question"] ?? "";
            let a  = item[KEY_ANSWER] ?? item["回答"] ?? item["answer"] ?? "";
            const r  = item[KEY_ROLE] ?? item["担当役職"] ?? item["role"] ?? "";

            if (a === "未回答") {
              a = `<span style="color:red;">${escapeHtml(a)}</span>`;
            } else {
              a = escapeHtml(a);
            }

            if (r) roleSet.add(r);

            return `<tr>
                      <td>${escapeHtml(dt)}</td>
                      <td>${escapeHtml(r)}</td>
                      <td>${escapeHtml(q)}</td>
                      <td>${a}</td>
                    </tr>`;
          }).join("");

          $('#qnaTable tbody').html(rowsHtml);

          // 役職絞り込みセレクトに選択肢を追加
          const roleArray = Array.from(roleSet).sort();
          const $roleFilter = $('#roleFilter');
          // 「すべて」以外をクリア
          $roleFilter.find('option:not(:first)').remove();
          roleArray.forEach(role => {
            $roleFilter.append($('<option>').val(role).text(role));
          });

          if ($.fn.dataTable.isDataTable('#qnaTable')) {
            $('#qnaTable').DataTable().clear().destroy();
          }

          $('#qnaTable').DataTable({
            "order": [[0, "desc"]],
            "pageLength": 10,
            "lengthMenu": [5,10,25,50],
            "language": {
              "search": "検索:",
              "lengthMenu": "表示件数 _MENU_ 件",
              "info": "_TOTAL_ 件中 _START_ から _END_ まで表示",
              "infoEmpty": "0 件中 0 から 0 まで表示",
              "infoFiltered": "（全 _MAX_ 件からフィルタリング）",
              "paginate": {
                "next": "次",
                "previous": "前"
              },
              "zeroRecords": "該当するデータがありません"
            },
            "columnDefs": [
              { "targets": [0,1,2,3], "defaultContent": "" }
            ]
          });

          $('#loading').hide();
          $('#tableContainer').show();
        })
        .catch(err => {
          $('#loading').hide();
          $('#error').text("データ取得エラー: " + err.message).show();
          console.error(err);
        });
    }

    // 簡易XSS対策エスケープ
    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
  </script>
</body>
</html>
